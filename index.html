<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Synapse - AI Voice Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* fallback */
            background-image: linear-gradient(160deg, #1e293b 0%, #0f172a 100%);
        }
        #chat-container::-webkit-scrollbar {
            width: 4px;
        }
        #chat-container::-webkit-scrollbar-thumb {
            background-color: #4b5563;
            border-radius: 20px;
        }
        .pulse {
            box-shadow: 0 0 0 0 rgba(239, 68, 68, 1);
            animation: pulse-red 2s infinite;
        }
        @keyframes pulse-red {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }
            70% {
                transform: scale(1);
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }
            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body class="text-white flex flex-col items-center justify-center min-h-screen p-4">

    <div id="login-container" class="w-full max-w-md text-center">
        <div class="bg-slate-800/50 backdrop-blur-sm p-8 rounded-2xl shadow-2xl border border-slate-700">
            <svg class="w-16 h-16 mx-auto mb-4 text-violet-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2Z"/><path d="M12 18a6 6 0 1 0 0-12 6 6 0 0 0 0 12Z"/><path d="M12 12a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z"/></svg>
            <h1 class="text-3xl font-bold text-gray-100 mb-2">Welcome to Synapse</h1>
            <p class="text-slate-400 mb-6">Your personal AI assistant. Sign in to continue.</p>
            <button id="google-signin-button" class="bg-white text-gray-800 font-semibold py-3 px-6 rounded-lg w-full flex items-center justify-center space-x-3 hover:bg-gray-200 transition-colors">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google icon" class="w-6 h-6">
                <span>Sign in with Google</span>
            </button>
        </div>
    </div>
    
    <div id="app-container" class="w-full max-w-2xl bg-slate-800/50 backdrop-blur-sm rounded-2xl shadow-2xl flex flex-col h-[85vh] hidden border border-slate-700">
        <div class="p-4 border-b border-slate-700 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                 <svg class="w-8 h-8 text-violet-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2Z"/><path d="M12 18a6 6 0 1 0 0-12 6 6 0 0 0 0 12Z"/><path d="M12 12a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z"/></svg>
                <h1 class="text-xl font-bold text-gray-200">Synapse</h1>
            </div>
            <div class="flex items-center space-x-4">
                <div id="user-info" class="flex items-center space-x-2">
                    <img id="user-photo" src="" alt="User" class="w-8 h-8 rounded-full">
                    <span id="user-name" class="text-sm text-gray-300"></span>
                </div>
                <div id="status-indicator" class="flex items-center space-x-2">
                    <span id="status-text" class="text-sm text-slate-400">Idle</span>
                    <div id="status-dot" class="w-3 h-3 bg-slate-500 rounded-full transition-colors duration-300"></div>
                </div>
                <button id="logout-button" class="text-sm text-slate-400 hover:text-white">Logout</button>
            </div>
        </div>

        <div id="chat-container" class="flex-grow p-4 overflow-y-auto space-y-4">
            </div>

        <div class="p-4 border-t border-slate-700">
             <div class="flex items-center space-x-4">
                <button id="mic-button" class="bg-slate-700 hover:bg-red-600 transition-all duration-300 text-white rounded-full w-14 h-14 flex-shrink-0 flex items-center justify-center shadow-lg focus:outline-none">
                    <i id="mic-icon" class="fa-solid fa-microphone text-xl"></i>
                </button>
                <form id="text-form" class="flex-grow flex items-center bg-slate-700 rounded-full px-4 py-1">
                    <input type="text" id="text-input" placeholder="Type a message..." class="bg-transparent w-full text-white placeholder-slate-400 focus:outline-none">
                    <button type="submit" class="text-violet-400 hover:text-violet-300 p-2">
                        <i class="fa-solid fa-paper-plane text-xl"></i>
                    </button>
                </form>
             </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

        const micButton = document.getElementById('mic-button');
        const micIcon = document.getElementById('mic-icon');
        const chatContainer = document.getElementById('chat-container');
        const statusText = document.getElementById('status-text');
        const statusDot = document.getElementById('status-dot');
        const loginContainer = document.getElementById('login-container');
        const appContainer = document.getElementById('app-container');
        const logoutButton = document.getElementById('logout-button');
        const googleSignInButton = document.getElementById('google-signin-button');
        const userName = document.getElementById('user-name');
        const userPhoto = document.getElementById('user-photo');
        const textForm = document.getElementById('text-form');
        const textInput = document.getElementById('text-input');

        // --- FIREBASE SETUP ---
        let app, auth, db, userId, chatUnsubscribe;
        let chatHistory = []; // To hold the conversation history
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        try {
            const firebaseConfig = {
              apiKey: "YOUR_FIREBASE_API_KEY", // <-- KEY REPLACED
              authDomain: "aivoiceassistant-48459.firebaseapp.com",
              projectId: "aivoiceassistant-48459",
              storageBucket: "aivoiceassistant-48459.appspot.com",
              messagingSenderId: "1037783174821",
              appId: "1:1037783174821:web:e82eb534b991e07452074c",
              measurementId: "G-Q7QMRC4YJV"
            };

            if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                const envConfig = JSON.parse(__firebase_config);
                if (envConfig.apiKey) {
                    Object.assign(firebaseConfig, envConfig);
                }
            }
            
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            setLogLevel('debug');
        } catch (e) {
            console.error("Firebase initialization failed:", e);
            loginContainer.innerHTML = `<div class="bg-gray-800 p-8 rounded-2xl shadow-2xl text-red-400">
                <h1 class="text-2xl font-bold mb-2">Initialization Failed</h1>
                <p>Could not initialize the application. Please check the console for errors.</p>
            </div>`;
        }

        // --- AUTHENTICATION ---
        async function signInWithGoogle() {
            const provider = new GoogleAuthProvider();
            provider.setCustomParameters({
                prompt: 'select_account'
            });
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Google Sign-In failed:", error);
                alert("Could not sign you in with Google. Please check the console for details.");
            }
        }

        googleSignInButton.addEventListener('click', signInWithGoogle);
        logoutButton.addEventListener('click', async () => {
            if (chatUnsubscribe) chatUnsubscribe();
            await signOut(auth);
        });

        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                userName.textContent = user.displayName || 'User';
                userPhoto.src = user.photoURL || `https://placehold.co/100x100/8b5cf6/ffffff?text=${(user.displayName || 'U').charAt(0)}`;
                
                loginContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                loadChatHistory();
            } else {
                userId = null;
                chatHistory = []; // Clear history on logout
                loginContainer.classList.remove('hidden');
                appContainer.classList.add('hidden');
                if (chatUnsubscribe) chatUnsubscribe();
                chatContainer.innerHTML = ''; // Clear chat on logout
            }
        });
        
        // --- FIRESTORE (MEMORY) ---
        async function saveMessage(text, sender) {
            if (!userId) return;
            try {
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/chats`), {
                    text: text,
                    sender: sender,
                    createdAt: serverTimestamp()
                });
            } catch (error) {
                console.error("Error saving message: ", error);
            }
        }

        function loadChatHistory() {
            if (chatUnsubscribe) chatUnsubscribe(); 

            const q = query(collection(db, `artifacts/${appId}/users/${userId}/chats`), orderBy("createdAt"));
            
            chatUnsubscribe = onSnapshot(q, (querySnapshot) => {
                chatContainer.innerHTML = ''; 
                chatHistory = []; // Reset history on every update from Firestore

                if (querySnapshot.empty) {
                    const initialMessage = "Hello! I'm Synapse. You can type or use the microphone to talk to me.";
                    renderMessage(initialMessage, 'assistant');
                    // Add the assistant's opening line to the history for context
                    chatHistory.push({ role: 'model', parts: [{ text: initialMessage }] });
                } else {
                    querySnapshot.forEach((doc) => {
                        const message = doc.data();
                        const role = message.sender === 'user' ? 'user' : 'model';
                        // Add message to local history
                        chatHistory.push({ role, parts: [{ text: message.text }] });
                        // Render message to UI
                        renderMessage(message.text, message.sender, true);
                    });
                }
            }, (error) => {
                 console.error("Error loading chat history:", error);
            });
        }


        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'en-US';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;
        } else {
            renderMessage("Sorry, your browser doesn't support the Web Speech API. Please try Chrome.", 'assistant');
            micButton.disabled = true;
        }
        
        const synth = window.speechSynthesis;
        let voices = [];

        function populateVoiceList() {
            if(typeof speechSynthesis === 'undefined') {
                return;
            }
            voices = synth.getVoices();
        }
        populateVoiceList();
        if (typeof speechSynthesis !== 'undefined' && speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = populateVoiceList;
        }


        // --- STATE MANAGEMENT ---
        function updateStatus(text, color) {
            statusText.textContent = text;
            statusDot.className = `w-3 h-3 rounded-full transition-colors duration-300 ${color}`;
        }
        
        micButton.addEventListener('click', () => {
            if (!recognition) return;
            
            if (micIcon.classList.contains('fa-microphone')) {
                startListening();
            } else {
                stopListening();
            }
        });
        
        textForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const transcript = textInput.value.trim();
            if (transcript) {
                saveMessage(transcript, 'user');
                processCommand(transcript);
                textInput.value = '';
            }
        });

        function startListening() {
            micIcon.classList.replace('fa-microphone', 'fa-stop');
            micButton.classList.add('pulse', 'bg-red-500');
            updateStatus('Listening...', 'bg-red-500');
            recognition.start();
        }

        function stopListening() {
            micIcon.classList.replace('fa-stop', 'fa-microphone');
            micButton.classList.remove('pulse', 'bg-red-500');
            updateStatus('Idle', 'bg-slate-500');
            recognition.stop();
        }

        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            saveMessage(transcript, 'user');
            processCommand(transcript);
        };

        recognition.onend = () => {
            stopListening();
        };

        recognition.onerror = (event) => {
            console.error('Speech recognition error:', event.error);
            saveMessage(`Error: ${event.error}. Please try again.`, 'assistant');
            stopListening();
        };
        
        // --- CHAT UI (Rendering only) ---
        function renderMessage(text, sender, skipAnimation = false) {
            const messageDiv = document.createElement('div');
            const assistantIcon = `<div class="p-2 rounded-full bg-violet-500 flex-shrink-0 flex items-center justify-center"><svg class="w-5 h-5 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2Z"/><path d="M12 18a6 6 0 1 0 0-12 6 6 0 0 0 0 12Z"/><path d="M12 12a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z"/></svg></div>`;
            const userIcon = `<div class="p-2 rounded-full bg-slate-600 flex-shrink-0 flex items-center justify-center"><i class="fa-solid fa-user text-white text-lg"></i></div>`;

            let content;
            if (sender === 'user') {
                content = `
                    <div class="flex items-start justify-end space-x-3">
                        <div class="bg-sky-500 p-3 rounded-lg max-w-md">
                            <p class="text-white">${text}</p>
                        </div>
                        ${userIcon}
                    </div>
                `;
            } else {
                 content = `
                    <div class="flex items-start space-x-3">
                        ${assistantIcon}
                        <div class="bg-slate-700 p-3 rounded-lg max-w-md">
                            <p class="text-slate-200">${text}</p>
                        </div>
                    </div>
                `;
            }
            messageDiv.innerHTML = content;
            if (!skipAnimation) {
                messageDiv.classList.add('fade-in');
            }
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        // --- COMMAND PROCESSING ---
        async function processCommand(command) {
            updateStatus('Processing...', 'bg-yellow-500');
            const lowerCaseCommand = command.toLowerCase();

            const openRegex = /open (.+)/;
            if (openRegex.test(lowerCaseCommand)) {
                let site = lowerCaseCommand.match(openRegex)[1].replace(/\s/g, '');
                if (!site.includes('.')) {
                    site += '.com';
                }
                const url = `https://www.${site}`;
                const responseText = `Sure, opening ${site}...`;
                saveMessage(responseText, 'assistant');
                speak(responseText);
                window.open(url, '_blank');
                updateStatus('Idle', 'bg-slate-500');
                return;
            }

             const playRegex = /play (.+)/;
             if (playRegex.test(lowerCaseCommand)) {
                const query = lowerCaseCommand.match(playRegex)[1];
                const url = `https://www.youtube.com/results?search_query=${encodeURIComponent(query)}`;
                const responseText = `Searching for "${query}" on YouTube...`;
                saveMessage(responseText, 'assistant');
                speak(responseText);
                window.open(url, '_blank');
                updateStatus('Idle', 'bg-slate-500');
                return;
            }
            
            // For general queries, pass the full conversation history for context
            const currentHistoryWithPrompt = [...chatHistory, { role: 'user', parts: [{ text: command }] }];
            await callGeminiAPI(command, currentHistoryWithPrompt);
        }
        
        // --- GEMINI API INTEGRATION ---
        async function callGeminiAPI(prompt, conversationHistory) {
             const apiKey = "YOUR_GEMINI_API_KEY"; // <-- KEY REPLACED
             
             if (!apiKey || apiKey === "YOUR_GEMINI_API_KEY" || apiKey === "PASTE_YOUR_GOOGLE_AI_API_KEY_HERE") {
                const errorMessage = "Google AI API key is missing. Please add it to the code.";
                console.error(errorMessage);
                saveMessage(errorMessage, 'assistant');
                speak(errorMessage);
                updateStatus('Error', 'bg-red-500');
                return;
             }

             const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;

             const systemPrompt = `You are a helpful and concise voice assistant. 
                Your name is Synapse. Today is ${new Date().toLocaleDateString()}.
                You are speaking with a user named ${auth.currentUser?.displayName || 'the user'}. You can greet them by name at the beginning of the conversation, but avoid repeating their name in subsequent responses to keep the conversation natural.
                The current location is Bengaluru, India unless the user specifies otherwise.
                Keep your responses short and conversational, suitable for being spoken aloud.
                Do not use markdown formatting.`;

             const payload = {
                  contents: conversationHistory, // Send the entire conversation history
                  systemInstruction: {
                      parts: [{ text: systemPrompt }]
                  },
                  tools: [{ "google_search": {} }] // For real-time info like weather
             };

             try {
                  let retries = 3;
                  let response;
                  while (retries > 0) {
                      try {
                          response = await fetch(apiUrl, {
                              method: 'POST',
                              headers: { 'Content-Type': 'application/json' },
                              body: JSON.stringify(payload)
                          });
                          if (response.ok) break;
                      } catch (error) {
                           console.error('Fetch error:', error);
                      }
                      retries--;
                      if (retries > 0) await new Promise(res => setTimeout(res, 1000 * (4 - retries)));
                  }

                   if (!response || !response.ok) {
                       throw new Error(`API request failed with status ${response.status}`);
                   }

                   const result = await response.json();
                   const assistantResponse = result.candidates?.[0]?.content?.parts?.[0]?.text;

                   if (assistantResponse) {
                       saveMessage(assistantResponse, 'assistant');
                       speak(assistantResponse);
                   } else {
                       throw new Error('No content in API response.');
                   }

             } catch (error) {
                  console.error('Error calling Gemini API:', error);
                  const errorMessage = 'I seem to be having trouble connecting. Please try again in a moment.';
                  saveMessage(errorMessage, 'assistant');
                  speak(errorMessage);
             } finally {
                  updateStatus('Idle', 'bg-slate-500');
             }
        }
        
        // --- TEXT-TO-SPEECH ---
        function speak(text) {
            if (synth.speaking) {
                console.error('SpeechSynthesis.speaking');
                return;
            }
            if (text !== '') {
                const utterThis = new SpeechSynthesisUtterance(text);
                utterThis.onstart = () => {
                    updateStatus('Speaking...', 'bg-sky-500');
                };
                utterThis.onend = () => {
                    updateStatus('Idle', 'bg-slate-500');
                };
                utterThis.onerror = (event) => {
                    console.error('SpeechSynthesisUtterance.onerror');
                    updateStatus('Idle', 'bg-slate-500');
                };
                
                const preferredVoice = voices.find(voice => voice.name === 'Google US English') || voices.find(voice => voice.lang === 'en-US');
                if (preferredVoice) {
                    utterThis.voice = preferredVoice;
                }

                synth.speak(utterThis);
            }
        }
    </script>
</body>
</html>

